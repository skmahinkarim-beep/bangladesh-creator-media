<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCM Admin Panel</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; margin: 0; }
        .container { max-width: 900px; margin: 20px auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        h3 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 10px; }
        
        /* Size Guide Style - RED COLOR */
        .size-guide { 
            color: #d9534f; 
            font-size: 0.85rem; 
            font-weight: bold; 
            margin-top: -5px; 
            margin-bottom: 10px; 
            display: block; 
        }
        
        input, textarea, button, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: bold; margin-top: 15px; display: block; color: #555; }
        .section { background: #f9f9f9; padding: 20px; margin-bottom: 25px; border-radius: 5px; border: 1px solid #e0e0e0; }
        .admin-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        button { background: #0056b3; color: white; cursor: pointer; font-weight: bold; font-size: 1rem; border: none; transition: 0.3s; }
        button:hover { background: #004494; }
        .logout-btn { background: #d9534f; margin-top: 20px; }
        .logout-btn:hover { background: #c9302c; }

        /* News Select Style */
        #news-select {
            background: #fff;
            font-size: 1.1rem;
            color: #0056b3;
            border: 2px solid #0056b3;
            font-weight: bold;
        }

        #admin-panel { display: none; }
        #login-section { max-width: 400px; margin: 50px auto; text-align: center; }

        /* AD CONTAINER STYLE */
        .ad-banner-container { text-align: center; margin: 20px auto; padding: 10px; max-width: 100%; overflow: hidden; }

        /* POPUP AD STYLES (Fixed) */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .popup-content {
            background: white; padding: 20px; border-radius: 12px;
            width: 350px; text-align: center; position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popIn 0.4s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 4px solid #f0f2f5; 
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Updated Close Button Style */
        .popup-close {
            position: absolute; top: -15px; right: -15px; background: red; color: white; border: 2px solid white;
            width: 35px; height: 35px; border-radius: 50%; font-size: 20px; line-height: 32px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 0;
        }
        .popup-close:hover { background: darkred; transform: scale(1.1); }

        /* ----------------------------------------------------
           NEW STYLES FOR STORE ADMIN & TABS
           ---------------------------------------------------- */
        .admin-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }
        .nav-btn {
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            background: #e0e0e0;
            color: #333;
            border: none;
        }
        .nav-btn.active {
            background: #0056b3;
            color: white;
            box-shadow: 0 4px 10px rgba(0,86,179,0.3);
        }

        /* Store Form Styles */
        .product-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width { grid-column: 1 / -1; }
        
        /* Image Preview with Zoom */
        .img-preview-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .img-preview-box {
            width: 80px;
            height: 80px;
            border: 1px solid #ddd;
            overflow: hidden;
            position: relative;
            background: #fff;
            border-radius: 5px;
        }
        .img-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }
        /* HOVER ZOOM EFFECT FOR IMAGES */
        .img-preview-box:hover img {
            transform: scale(2.5); /* Zoom in */
            z-index: 100;
        }
        
        .search-result-item {
            padding: 10px;
            background: white;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:hover { background: #f0f7ff; }
        .btn-green { background: #28a745 !important; }
        .btn-green:hover { background: #218838 !important; }
        
        #store-admin-tab { display: none; } /* Hidden by default */
    </style>
</head>
<body>

    <!-- Login Section -->
    <div id="login-section" class="container">
        <h3>Admin Login</h3>
        <input type="email" id="email" placeholder="Admin Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel" class="container">
        <h1>Website Control Panel</h1>

        <!-- NAVIGATION TABS -->
        <div class="admin-nav">
            <button class="nav-btn active" onclick="switchTab('main')">Main Admin</button>
            <button class="nav-btn" onclick="switchTab('store')">Store Admin üõí</button>
        </div>

        <!-- ADSTERRA BANNER 728x90 (Visible on both tabs) -->
        <div class="ad-banner-container">
            <script>
                atOptions = {
                    'key' : '913c56baf27591442617260739df7bf0',
                    'format' : 'iframe',
                    'height' : 90,
                    'width' : 728,
                    'params' : {}
                };
            </script>
            <script src="https://www.highperformanceformat.com/913c56baf27591442617260739df7bf0/invoke.js"></script>
        </div>
        
        <!-- ==============================================
             TAB 1: MAIN ADMIN CONTENT (Existing Code)
             ============================================== -->
        <div id="main-admin-tab">
            <!-- 1. BREAKING NEWS -->
            <div class="section" style="border-left: 5px solid #ff0000; background: #fff5f5;">
                <h3 style="margin-top: 0; color: #d32f2f;">üì¢ Breaking News Ticker</h3>
                <label>Scrolling Text:</label>
                <input type="text" id="breaking-news" placeholder="Write breaking news here... (Leave empty to hide ticker)">
            </div>

            <!-- 2. Top Banners -->
            <div class="section">
                <h3>2. Top Full-Screen Banners</h3>
                
                <label>Banner 1:</label>
                <input type="text" id="b1-img" placeholder="Paste Image Link Here">
                <span class="size-guide">‚ÑπÔ∏è Recommended Size: 1920 x 600 px (Wide Banner)</span>
                <input type="text" id="b1-link" placeholder="Paste YouTube Link Here">

                <label>Banner 2:</label>
                <input type="text" id="b2-img" placeholder="Paste Image Link Here">
                <span class="size-guide">‚ÑπÔ∏è Recommended Size: 1920 x 600 px (Wide Banner)</span>
                <input type="text" id="b2-link" placeholder="Paste YouTube Link Here">

                <label>Banner 3:</label>
                <input type="text" id="b3-img" placeholder="Paste Image Link Here">
                <span class="size-guide">‚ÑπÔ∏è Recommended Size: 1920 x 600 px (Wide Banner)</span>
                <input type="text" id="b3-link" placeholder="Paste YouTube Link Here">
            </div>

            <!-- 3. Video Grid -->
            <div class="section">
                <h3>3. Video Grid (6 Items)</h3>
                <div id="video-inputs"></div>
            </div>

            <!-- 4. Text Content (3 BOXES) -->
            <div class="section">
                <h3>4. Important Text Sections</h3>
                
                <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                    <label style="margin-top:0;">Text Box 1 (Title & Content):</label>
                    <input type="text" id="txt-title" placeholder="Title 1">
                    <textarea id="txt-desc" rows="4" placeholder="Content 1..."></textarea>
                </div>

                <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                    <label style="margin-top:0;">Text Box 2 (Title & Content):</label>
                    <input type="text" id="txt-title-2" placeholder="Title 2">
                    <textarea id="txt-desc-2" rows="4" placeholder="Content 2..."></textarea>
                </div>

                <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <label style="margin-top:0;">Text Box 3 (Title & Content):</label>
                    <input type="text" id="txt-title-3" placeholder="Title 3">
                    <textarea id="txt-desc-3" rows="4" placeholder="Content 3..."></textarea>
                </div>
            </div>

            <!-- 5. Statistics -->
            <div class="section">
                <h3>5. Statistics (Numbers)</h3>
                <div class="admin-stat-grid">
                    <div><label>Years Exp:</label><input type="text" id="s1-num"><input type="text" id="s1-lbl"></div>
                    <div><label>Projects:</label><input type="text" id="s2-num"><input type="text" id="s2-lbl"></div>
                    <div><label>Running:</label><input type="text" id="s3-num"><input type="text" id="s3-lbl"></div>
                    <div><label>Satisfaction:</label><input type="text" id="s4-num"><input type="text" id="s4-lbl"></div>
                </div>
            </div>

            <!-- 6. Bottom Left Notice -->
            <div class="section" style="border-left: 5px solid #28a745; background: #f0fff4;">
                <h3 style="margin-top: 0; color: #28a745;">üîî Bottom Left Notice Popup</h3>
                <label>Notice Content:</label>
                <textarea id="bottom-notice-text" rows="3" placeholder="Write your notice here... (Leave empty to disable)"></textarea>
            </div>

            <!-- 7. BLOG & NEWS MANAGEMENT -->
            <div class="section" style="border-left: 5px solid #0056b3; background: #eef7ff;">
                <h3 style="margin-top: 0; color: #0056b3;">üì∞ Blog & News Management (30 Slots)</h3>
                <p>Select a News Slot number to edit that specific news.</p>
                
                <label>Select News Slot:</label>
                <select id="news-select" onchange="loadSpecificNews()">
                    <!-- Options 1 to 30 generated by JS -->
                </select>

                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ccc; margin-top: 15px;">
                    <label>News Title:</label>
                    <input type="text" id="news-title" placeholder="Enter News Headline">
                    
                    <label>Thumbnail Image Link:</label>
                    <input type="text" id="news-img" placeholder="Paste Image Link">
                    <span class="size-guide">‚ÑπÔ∏è Recommended Ratio: 16:9 (Example: 600x340 px)</span>
                    
                    <label>Date / Author:</label>
                    <input type="text" id="news-date" placeholder="e.g. 21 Jan 2026 | Admin">

                    <label>Full Content (Description):</label>
                    <textarea id="news-desc" rows="10" placeholder="Write the full news article here... (Minimum 500 words recommended for AdSense)"></textarea>
                </div>
            </div>

            <button onclick="saveData()" style="padding: 15px; font-size: 1.2rem; background: #28a745;">SAVE MAIN SITE CHANGES</button>
        </div>
        <!-- END MAIN ADMIN TAB -->


        <!-- ==============================================
             TAB 2: STORE ADMIN CONTENT (New Section)
             ============================================== -->
        <div id="store-admin-tab">
            <div class="section" style="border-left: 5px solid #ff9800; background: #fff8e1;">
                <h3 style="margin-top: 0; color: #e65100;">üõí Manage Store Products</h3>
                
                <!-- Search and Controls -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="store-search" placeholder="Search by Product Name..." onkeyup="searchProducts()" style="margin:0;">
                    <button onclick="clearStoreForm()" style="width: 150px; background: #0056b3;">+ Add New</button>
                </div>
                
                <!-- Product List (Search Results) -->
                <div id="product-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 20px; display: none;"></div>

                <!-- Product Form -->
                <div id="store-form" style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    
                    <!-- Serial Number -->
                    <label>8. Serial Number (Order ID):</label>
                    <input type="number" id="p-serial" placeholder="e.g. 101">

                    <label>1. Product Images (4 Images - Hover to Zoom):</label>
                    <div class="product-form-grid">
                        <input type="text" id="p-img1" placeholder="Image Link 1 (ImgBB)" oninput="updatePreview(1)">
                        <input type="text" id="p-img2" placeholder="Image Link 2" oninput="updatePreview(2)">
                        <input type="text" id="p-img3" placeholder="Image Link 3" oninput="updatePreview(3)">
                        <input type="text" id="p-img4" placeholder="Image Link 4" oninput="updatePreview(4)">
                    </div>
                    
                    <!-- Preview Area -->
                    <div class="img-preview-container">
                        <div class="img-preview-box"><img id="prev-1" src="" alt=""></div>
                        <div class="img-preview-box"><img id="prev-2" src="" alt=""></div>
                        <div class="img-preview-box"><img id="prev-3" src="" alt=""></div>
                        <div class="img-preview-box"><img id="prev-4" src="" alt=""></div>
                    </div>

                    <div class="product-form-grid">
                        <div class="full-width">
                            <label>2. Product Title:</label>
                            <input type="text" id="p-title" placeholder="e.g. Smart Watch Ultra">
                        </div>

                        <div>
                            <label>3. Current Price (Tk):</label>
                            <input type="text" id="p-price" placeholder="e.g. 1200">
                        </div>
                        <div>
                            <label>4. Old Price (Tk) - Strikethrough:</label>
                            <input type="text" id="p-old-price" placeholder="e.g. 2000">
                        </div>
                        
                        <div>
                            <label>6. Rating (1-5):</label>
                            <input type="number" id="p-rating" min="1" max="5" placeholder="e.g. 5">
                        </div>

                        <div class="full-width">
                            <label>7. Buy Now / Affiliate Link:</label>
                            <input type="text" id="p-link" placeholder="Paste Affiliate Link Here">
                        </div>

                        <div class="full-width">
                            <label>5. Description:</label>
                            <textarea id="p-desc" rows="5" placeholder="Product Details..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Hidden field to store ID if editing -->
                    <input type="hidden" id="p-id"> 

                    <button onclick="saveStoreProduct()" class="btn-green" style="margin-top: 20px;">SAVE PRODUCT</button>
                    <p id="store-msg" style="text-align: center; font-weight: bold; margin-top: 10px;"></p>
                </div>
            </div>
        </div>
        <!-- END STORE ADMIN TAB -->

        <!-- ADSTERRA NATIVE BANNER (Visible on both) -->
        <div style="margin: 20px auto; text-align: center; max-width: 100%;">
            <script async="async" data-cfasync="false" src="https://pl28530993.effectivegatecpm.com/04804b2bd758cb3163372944a85a8bb2/invoke.js"></script>
            <div id="container-04804b2bd758cb3163372944a85a8bb2"></div>
        </div>
        <!-- END NATIVE BANNER -->

        <button onclick="logout()" class="logout-btn">Logout</button>
    </div>

    <!-- MAIN POP-UP AD (300x250) -->
    <div class="popup-overlay" id="popup-ad">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup()">‚úñ</button>
            <h3 style="margin-bottom:10px;">Special Offer!</h3>
            <div>
                <script>
                    atOptions = {
                        'key' : '08d5faeff146431c8017d7cfc9ab82b6',
                        'format' : 'iframe',
                        'height' : 250,
                        'width' : 300,
                        'params' : {}
                    };
                </script>
                <script src="https://www.highperformanceformat.com/08d5faeff146431c8017d7cfc9ab82b6/invoke.js"></script>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEfAusfGr5VAhwbfpEjWBZijX0k3v3vAA",
            authDomain: "bangladesh-creator-media.firebaseapp.com",
            projectId: "bangladesh-creator-media",
            storageBucket: "bangladesh-creator-media.firebasestorage.app",
            messagingSenderId: "261777783760",
            appId: "1:261777783760:web:9dcacf82fdca071f4b97d5"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // GLOBAL VARIABLES
        let allData = {};
        let storeProducts = []; // To store product list locally

        // TAB SWITCHING LOGIC
        function switchTab(tab) {
            const mainTab = document.getElementById('main-admin-tab');
            const storeTab = document.getElementById('store-admin-tab');
            const btns = document.querySelectorAll('.nav-btn');

            if (tab === 'main') {
                mainTab.style.display = 'block';
                storeTab.style.display = 'none';
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                mainTab.style.display = 'none';
                storeTab.style.display = 'block';
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
                loadStoreData(); // Load products when tab is opened
            }
        }

        // Generate Video Inputs
        const vidContainer = document.getElementById('video-inputs');
        for(let i=1; i<=6; i++) {
            vidContainer.innerHTML += `
                <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                    <strong>Video ${i}</strong>
                    <input type="text" id="v${i}-title" placeholder="Video Title">
                    <input type="text" id="v${i}-img" placeholder="Paste Thumbnail Link">
                    <span class="size-guide">‚ÑπÔ∏è Recommended Size: 1280 x 720 px</span>
                    <input type="text" id="v${i}-link" placeholder="Paste YouTube Link">
                </div>
            `;
        }

        // Generate News Dropdown Options
        const newsSelect = document.getElementById('news-select');
        for(let i=1; i<=30; i++) {
            let option = document.createElement("option");
            option.value = i - 1;
            option.text = "News Slot " + i;
            newsSelect.appendChild(option);
        }

        // Auth & Load Data
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadData();
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p)
                .then(() => alert("Login Successful!"))
                .catch(err => alert("Error: " + err.message));
        }

        function logout() { auth.signOut(); }

        // Load Main Site Data
        function loadData() {
            db.collection('siteContent').doc('homePage').get().then(doc => {
                if(doc.exists) {
                    allData = doc.data();
                    if(allData.breakingNews) document.getElementById('breaking-news').value = allData.breakingNews;
                    if(allData.bottomNotice) document.getElementById('bottom-notice-text').value = allData.bottomNotice;
                    
                    if(allData.banners) {
                        allData.banners.forEach((b, i) => {
                            if(i<3) {
                                document.getElementById(`b${i+1}-img`).value = b.img || '';
                                document.getElementById(`b${i+1}-link`).value = b.link || '';
                            }
                        });
                    }

                    if(allData.videos) {
                        allData.videos.forEach((v, index) => {
                            let i = index + 1;
                            if(i <= 6) {
                                document.getElementById(`v${i}-title`).value = v.title || '';
                                document.getElementById(`v${i}-img`).value = v.img || '';
                                document.getElementById(`v${i}-link`).value = v.link || '';
                            }
                        });
                    }

                    if(allData.textSection) { document.getElementById('txt-title').value = allData.textSection.title || ''; document.getElementById('txt-desc').value = allData.textSection.desc || ''; }
                    if(allData.textSection2) { document.getElementById('txt-title-2').value = allData.textSection2.title || ''; document.getElementById('txt-desc-2').value = allData.textSection2.desc || ''; }
                    if(allData.textSection3) { document.getElementById('txt-title-3').value = allData.textSection3.title || ''; document.getElementById('txt-desc-3').value = allData.textSection3.desc || ''; }

                    if(allData.stats) {
                        document.getElementById('s1-num').value = allData.stats.s1?.num || ''; document.getElementById('s1-lbl').value = allData.stats.s1?.lbl || '';
                        document.getElementById('s2-num').value = allData.stats.s2?.num || ''; document.getElementById('s2-lbl').value = allData.stats.s2?.lbl || '';
                        document.getElementById('s3-num').value = allData.stats.s3?.num || ''; document.getElementById('s3-lbl').value = allData.stats.s3?.lbl || '';
                        document.getElementById('s4-num').value = allData.stats.s4?.num || ''; document.getElementById('s4-lbl').value = allData.stats.s4?.lbl || '';
                    }

                    loadSpecificNews();
                }
            });
        }

        function loadSpecificNews() {
            const index = document.getElementById('news-select').value;
            if(!allData.news) allData.news = [];
            const newsItem = allData.news[index] || {};
            document.getElementById('news-title').value = newsItem.title || '';
            document.getElementById('news-img').value = newsItem.img || '';
            document.getElementById('news-date').value = newsItem.date || '';
            document.getElementById('news-desc').value = newsItem.desc || '';
        }

        function saveData() {
            const index = document.getElementById('news-select').value;
            if(!allData.news) allData.news = [];
            
            allData.news[index] = {
                title: document.getElementById('news-title').value,
                img: document.getElementById('news-img').value,
                date: document.getElementById('news-date').value,
                desc: document.getElementById('news-desc').value
            };

            const dataToSave = {
                breakingNews: document.getElementById('breaking-news').value,
                bottomNotice: document.getElementById('bottom-notice-text').value,
                banners: [
                    { img: document.getElementById('b1-img').value, link: document.getElementById('b1-link').value },
                    { img: document.getElementById('b2-img').value, link: document.getElementById('b2-link').value },
                    { img: document.getElementById('b3-img').value, link: document.getElementById('b3-link').value }
                ],
                videos: [],
                textSection: { title: document.getElementById('txt-title').value, desc: document.getElementById('txt-desc').value },
                textSection2: { title: document.getElementById('txt-title-2').value, desc: document.getElementById('txt-desc-2').value },
                textSection3: { title: document.getElementById('txt-title-3').value, desc: document.getElementById('txt-desc-3').value },
                stats: {
                    s1: { num: document.getElementById('s1-num').value, lbl: document.getElementById('s1-lbl').value },
                    s2: { num: document.getElementById('s2-num').value, lbl: document.getElementById('s2-lbl').value },
                    s3: { num: document.getElementById('s3-num').value, lbl: document.getElementById('s3-lbl').value },
                    s4: { num: document.getElementById('s4-num').value, lbl: document.getElementById('s4-lbl').value }
                },
                news: allData.news
            };

            for(let i=1; i<=6; i++) {
                dataToSave.videos.push({
                    title: document.getElementById(`v${i}-title`).value,
                    img: document.getElementById(`v${i}-img`).value,
                    link: document.getElementById(`v${i}-link`).value
                });
            }

            db.collection('siteContent').doc('homePage').set(dataToSave)
                .then(() => alert('Main Website Updated Successfully!'))
                .catch(err => alert('Error: ' + err.message));
        }

        // ==========================================
        // STORE ADMIN LOGIC (NEW)
        // ==========================================
        function loadStoreData() {
            // We use 'storePage' doc to store an array of products
            db.collection('siteContent').doc('storePage').get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    storeProducts = data.products || [];
                    // We don't display list immediately, user must search or add new
                } else {
                    storeProducts = [];
                }
            });
        }

        function updatePreview(num) {
            const url = document.getElementById(`p-img${num}`).value;
            document.getElementById(`prev-${num}`).src = url;
        }

        function clearStoreForm() {
            document.getElementById('p-id').value = ''; // Empty means new
            document.getElementById('p-serial').value = '';
            document.getElementById('p-title').value = '';
            document.getElementById('p-img1').value = '';
            document.getElementById('p-img2').value = '';
            document.getElementById('p-img3').value = '';
            document.getElementById('p-img4').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-old-price').value = '';
            document.getElementById('p-rating').value = '';
            document.getElementById('p-link').value = '';
            document.getElementById('p-desc').value = '';
            
            // Clear previews
            for(let i=1; i<=4; i++) document.getElementById(`prev-${i}`).src = '';
            
            document.getElementById('store-msg').innerText = "Mode: Add New Product";
        }

        function searchProducts() {
            const query = document.getElementById('store-search').value.toLowerCase();
            const listContainer = document.getElementById('product-list');
            listContainer.innerHTML = '';
            
            if(query.length < 1) {
                listContainer.style.display = 'none';
                return;
            }

            const filtered = storeProducts.filter(p => p.title.toLowerCase().includes(query) || p.serial.toString().includes(query));
            
            if(filtered.length > 0) {
                listContainer.style.display = 'block';
                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `<span><strong>#${p.serial}</strong> - ${p.title}</span> <button style="width:auto; padding:5px 10px;" onclick='editProduct("${p.serial}")'>Edit</button>`;
                    listContainer.appendChild(div);
                });
            } else {
                listContainer.style.display = 'none';
            }
        }

        function editProduct(serial) {
            const product = storeProducts.find(p => p.serial == serial);
            if(product) {
                // Determine logic: We use Serial as ID for simplicity in search, but array index for update
                // Actually, let's just fill the form
                document.getElementById('p-id').value = 'edit'; // Mark as edit mode
                document.getElementById('p-serial').value = product.serial;
                document.getElementById('p-title').value = product.title;
                document.getElementById('p-img1').value = product.images[0] || '';
                document.getElementById('p-img2').value = product.images[1] || '';
                document.getElementById('p-img3').value = product.images[2] || '';
                document.getElementById('p-img4').value = product.images[3] || '';
                document.getElementById('p-price').value = product.price;
                document.getElementById('p-old-price').value = product.oldPrice;
                document.getElementById('p-rating').value = product.rating;
                document.getElementById('p-link').value = product.link;
                document.getElementById('p-desc').value = product.desc;

                // Update previews
                updatePreview(1); updatePreview(2); updatePreview(3); updatePreview(4);
                
                document.getElementById('product-list').style.display = 'none'; // Hide list
                document.getElementById('store-msg').innerText = "Mode: Editing Product #" + product.serial;
            }
        }

        function saveStoreProduct() {
            const serial = document.getElementById('p-serial').value;
            if(!serial) { alert("Serial Number is required!"); return; }

            const newProduct = {
                serial: serial,
                title: document.getElementById('p-title').value,
                images: [
                    document.getElementById('p-img1').value,
                    document.getElementById('p-img2').value,
                    document.getElementById('p-img3').value,
                    document.getElementById('p-img4').value
                ],
                price: document.getElementById('p-price').value,
                oldPrice: document.getElementById('p-old-price').value,
                rating: document.getElementById('p-rating').value,
                link: document.getElementById('p-link').value,
                desc: document.getElementById('p-desc').value
            };

            // Check if product exists (by serial)
            const existingIndex = storeProducts.findIndex(p => p.serial == serial);

            if(existingIndex > -1) {
                // Update existing
                storeProducts[existingIndex] = newProduct;
            } else {
                // Add new
                storeProducts.push(newProduct);
            }

            // Save entire array back to Firebase
            db.collection('siteContent').doc('storePage').set({ products: storeProducts })
                .then(() => {
                    alert('Product Saved Successfully!');
                    clearStoreForm();
                    loadStoreData(); // Refresh local list
                })
                .catch(err => alert("Error saving product: " + err.message));
        }

        // --- POPUP AD LOGIC (ADMIN) ---
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (!sessionStorage.getItem('popupClosedAdmin')) {
                    document.getElementById('popup-ad').style.display = 'flex';
                }
            }, 2000);
        });

        function closePopup() {
            document.getElementById('popup-ad').style.display = 'none';
            sessionStorage.setItem('popupClosedAdmin', 'true');
        }
    </script>

    <!-- ADSTERRA POPUNDER AD -->
    <script src="https://pl28528078.effectivegatecpm.com/ac/d5/c2/acd5c23b9f6f77e8f9f6ebae6a44ab89.js"></script>

    <!-- ADSTERRA SOCIAL BAR AD -->
    <script src="https://pl28528081.effectivegatecpm.com/ef/bf/ed/efbfedfbecfa4341c8c49c5e2eb5597a.js"></script>

    <!-- ADSTERRA SMARTLINK -->
    <script>
        document.body.addEventListener('click', function() {
            if(!sessionStorage.getItem('smartLinkShownAdmin')) {
                window.open('https://www.effectivegatecpm.com/tvh8g9tv2?key=d1007f785c6fd53c1310c7811f50889e', '_blank');
                sessionStorage.setItem('smartLinkShownAdmin', 'true');
            }
        }, { once: true });
    </script>

</body>
</html>
